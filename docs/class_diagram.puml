@startuml
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 50
skinparam ranksep 50

title Milo Mail System - Architecture & Design Patterns

package "Controllers" {
    class MailController <<Facade>> {
        + getMails(String filter, String val)
        + sendMail(MultipartFile[], String mailDTO)
        + getSortedMails(String sortBy, String folder)
        + moveMails(List<Long>, String folder)
    }
    class ContactController {
        + getContacts(String sort)
        + addContact(Contact)
        + deleteContact(Long)
    }
    class AuthController {
        + register(UserDTO)
        + login(UserDTO)
    }
    class FolderController {
        + getAllFolders()
        + createFolder(String)
        + deleteFolder(String)
        + updateFolder(String, String)
    }
    class AttachmentController {
        + downloadAttachment(Long)
    }
    class FilterRuleController {
        + getFilterRules()
        + addFilterRule(FilterRuleDTO)
        + deleteFilterRule(Long)
    }
}

package "Services (Singleton Pattern)" {
    class MailService <<Facade>> <<Singleton>> {
        + GetAllMails()
        + saveMail(MailDTO, MultipartFile[])
        + updateMail(MailDTO, MultipartFile[])
        + deleteMail(Long id)
        + getMailsByFolder(String, int, int)
        + getSortedMails(String, String, int, int)
        + Search(SearchDTO, int, int)
        + Filter(FilterDTO, int, int)
    }
    class TrashCleanupService <<Singleton>> {
        + cleanOldMails()
        + deleteOldMails()
    }
    class ContactService <<Singleton>> {
        + getContacts()
        + addContact(Contact)
        + getSortedContacts(String)
    }
    class AuthService <<Singleton>> {
        + register(ClientUser)
        + verify(ClientUser)
        + exists(String)
    }
    class FolderService <<Singleton>> {
        + getFolderNames()
        + createFolder(String)
        + removeFolder(String)
        + renameFolder(String, String)
    }
    class AttachmentService <<Singleton>> {
        + getAttachmentData(Long)
        + convertDTOsToAttachments(List, List)
    }
    class JWTService <<Singleton>> {
        + generateToken(String)
        + validateToken(String, UserDetails)
        + extractEmail(String)
    }
    class FilterRuleService <<Singleton>> {
        + getFilters()
        + addFilter(FilterRuleDTO)
        + deleteFilter(Long)
    }
}

package "Security (Chain of Responsibility)" {
    abstract class OncePerRequestFilter {
        + doFilterInternal(req, res, chain)
    }
    class JWTFilter extends OncePerRequestFilter {
        + doFilterInternal(req, res, chain)
    }
    class SecurityConfig {
        + filterChain(HttpSecurity)
    }
}

package "Cache (Caffeine)" {
    class CacheConfig <<Configuration>> {
        + cacheManager(): CacheManager
    }
    class CaffeineCacheManager {
        + getCache(String): Cache
    }
    note right of CacheConfig: Local in-memory cache\nfor storing Java objects\nwithout serialization
}

package "Mappers (Mapper Pattern)" {
    interface MailMapper <<Interface>> {
        + toDto(Mail) : MailDTO
        + toEntity(MailDTO, List<MultipartFile>) : Mail
    }
    class MailMapperImpl implements MailMapper
    
    interface AttachmentMapper <<Interface>> {
        + toDto(Attachment) : AttachmentDTO
        + toEntity(AttachmentDTO) : Attachment
    }
    class AttachmentMapperImpl implements AttachmentMapper
}

package "Data Transfer Objects" {
    class MailDTO {
        + String subject
        + String body
        + int priority
        + String senderEmail
        + Queue<String> receiverEmails
        + List<AttachmentDTO> attachments
    }
    class UserDTO {
        + String name
        + String email
        + String token
    }
    class FilterRuleDTO {
        + Map<String, String> criteriaTypesValues
        + String actionType
        + String actionTarget
    }
    class FilterDTO {
        + String folder
        + Map<String, String> keys
    }
    class SearchDTO {
        + String folder
        + String word
    }
}

package "Repositories (Repository Pattern)" {
    interface MailRepo <<Interface>>
    interface ContactRepo <<Interface>>
    interface UserRepo <<Interface>>
    interface FolderRepo <<Interface>>
    interface AttachmentRepo <<Interface>>
    interface FilterRuleRepo <<Interface>>
}

package "Models (Builder & Prototype Pattern)" {
    interface Prototype<T> <<Interface>> {
        + clone(): T
    }
    
    class Mail <<Builder>> implements Prototype {
        - Long id
        - String subject
        - String body
        - LocalDateTime sentAt
        - boolean read
        - boolean starred
        - boolean hasAttachment
        - int priority
        + static MailBuilder builder()
        + clone(): Mail
        + cloneWithReceiver(ClientUser): Mail
        + update(Mail source)
    }
    class Attachment {
        - Long id
        - String name
        - String type
        - long size
    }
    class AttachmentContent {
        - byte[] data
    }
    class Contact {
        - Long id
        - String name
        - List<String> emails
    }
    class ClientUser {
        - Long id
        - String name
        - String email
        - String password
    }
    class Folder {
        - Long id
        - String name
    }
    class FilterRule {
        - Long id
        - Map<String, String> criteriaTypesValues
        - String actionType
        - String actionTarget
        + check(Mail): boolean
        + apply(Mail, ActionFactory)
    }

    Mail "1" *-- "*" Attachment : contains
    Attachment "1" -- "1" AttachmentContent : has content
    Mail "*" -- "1" ClientUser : sender
    Mail "*" -- "1" ClientUser : receiver
    Mail "*" -- "1" Folder : belongs to
    ClientUser "1" *-- "*" Contact : has contacts
    ClientUser "1" *-- "*" FilterRule : owns rules
    ClientUser "1" *-- "*" Folder : has folders
}

package "Commands (Command Pattern)" {
    interface FilterRuleAction <<Interface>> {
        + execute(Mail, String)
    }
    class ActionFactory <<Factory>> <<Singleton>> {
        - Map<String, FilterRuleAction> actionMap
        + getAction(String): FilterRuleAction
    }
    class MoveToAction implements FilterRuleAction {
        + execute(Mail, String)
    }
    class StarAction implements FilterRuleAction {
        + execute(Mail, String)
    }
    class MarkAsReadAction implements FilterRuleAction {
        + execute(Mail, String)
    }
}

package "Strategies (Strategy Pattern)" {
    class SortWorker {
        - MailSortingStrategy strategy
        + setStrategy(MailSortingStrategy)
        + sort(List<Mail>) : List<Mail>
    }
    interface MailSortingStrategy <<Interface>> {
        + SortingMails(List<Mail>) : List<Mail>
    }
    class SortByDate implements MailSortingStrategy
    class SortBySubject implements MailSortingStrategy
    class SortByPriority implements MailSortingStrategy
    class SortBySender implements MailSortingStrategy
    class SortByBody implements MailSortingStrategy
    class SortByReceiver implements MailSortingStrategy
    class SortByAttachment implements MailSortingStrategy

    class ContactSortWorker {
        - ContactSortingStrategy strategy
        + sort(List<Contact>)
    }
    interface ContactSortingStrategy <<Interface>> {
        + sort(List<Contact>)
    }
    class ContactSortByName implements ContactSortingStrategy
    class ContactSortByEmails implements ContactSortingStrategy
}

package "Filters (Criteria Pattern)" {
    interface Criteria <<Interface>> {
        + filter(List<Mail>) : List<Mail>
    }
    class CriteriaFactory <<Factory>> {
        + create(String name, String value) : Criteria
    }
    class CriteriaSubject implements Criteria
    class CriteriaSender implements Criteria
    class CriteriaPriority implements Criteria
    class CriteriaBody implements Criteria
    class CriteriaReceiver implements Criteria
    class CriteriaDay implements Criteria
    class CriteriaMonth implements Criteria
    class CriteriaYear implements Criteria
    class CriteriaHour implements Criteria
    class CriteriaMinute implements Criteria
    class CriteriaHasAttachment implements Criteria
}

' Relationships
MailController --> MailService : Delegates
ContactController --> ContactService : Delegates
AuthController --> AuthService : Delegates
FolderController --> FolderService : Delegates
AttachmentController --> AttachmentService : Delegates
FilterRuleController --> FilterRuleService : Delegates

MailService --> MailRepo : Uses
MailService --> UserRepo : Uses
MailService --> FolderRepo : Uses
MailService --> MailMapperImpl : Uses
MailService ..> SortWorker : Uses
MailService ..> CriteriaFactory : Uses
MailService --> ActionFactory : Uses
MailService --> FilterRuleRepo : Uses

ContactService --> ContactRepo : Uses
ContactService ..> ContactSortWorker : Uses

AuthService --> UserRepo : Uses
AuthService --> JWTService : Uses
AuthService --> FolderService : Uses

FolderService --> FolderRepo : Uses
AttachmentService --> AttachmentRepo : Uses
FilterRuleService --> FilterRuleRepo : Uses

MailMapperImpl ..> MailDTO : Creates
MailMapperImpl ..> Mail : Maps to

CriteriaFactory ..> Criteria : Creates
ActionFactory ..> FilterRuleAction : Creates
SortWorker o-- MailSortingStrategy : Has
ContactSortWorker o-- ContactSortingStrategy : Has

FilterRule --> ActionFactory : Uses

SecurityConfig --> JWTFilter : Configures

@enduml
