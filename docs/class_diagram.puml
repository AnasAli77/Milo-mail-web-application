@startuml
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 50
skinparam ranksep 50

title Milo Mail System - Architecture & Design Patterns

package "Controllers (Facade Pattern)" {
    class MailController {
        + getMails(String filter, String val)
        + sendMail(MultipartFile[], String mailDTO)
    }
    class ContactController {
        + getContacts(String sort)
        + addContact(Contact)
    }
    class AuthController {
        + register(UserDTO)
        + login(UserDTO)
    }
    class FolderController {
        + getAllFolders()
        + createFolder(String)
        + deleteFolder(String)
        + updateFolder(String, String)
    }
    class AttachmentController {
        + downloadAttachment(Long)
    }
    class FilterRuleController {
        + getFilterRules()
        + addFilterRule(FilterRuleDTO)
        + deleteFilterRule(Long)
    }
}

package "Services (Singleton Pattern)" {
    class MailService {
        + GetAllMails()
        + saveMail(MailDTO, MultipartFile[])
        + updateMail(MailDTO, MultipartFile[])
        + deleteMail(Long id) 
    }
    class TrashCleanupService {
        + cleanOldMails()
        + deleteOldMails()
    }
    class ContactService {
        + getContacts()
        + addContact(Contact)
    }
    class AuthService {
        + register(ClientUser)
        + verify(ClientUser)
        + exists(String)
    }
    class FolderService {
        + getFolderNames()
        + createFolder(String)
        + removeFolder(String)
        + renameFolder(String, String)
    }
    class AttachmentService {
        + getAttachmentData(Long)
        + convertDTOsToAttachments(List, List)
    }
    class JWTService {
        + generateToken(String)
        + validateToken(String)
    }
    class FilterRuleService {
        + getFilters()
        + addFilter(FilterRuleDTO)
        + deleteFilter(Long)
    }
}

package "Mappers (Architectural Pattern)" {
    class MailMapperImpl {
        + toDto(Mail) : MailDTO
        + toEntity(MailDTO) : Mail
    }
}

package "Data Transfer Objects" {
    class MailDTO {
        + String subject
        + String body
        + int priority
        + String senderEmail
        + List<String> receiverEmails
    }
    class UserDTO {
        + String name
        + String email
        + String token
    }
    class FilterRuleDTO {
        + Map<String, String> criteriaTypesValues
        + String actionType
        + String actionTarget
    }
}

package "Repositories (Repository Pattern)" {
    interface MailRepo <<Interface>>
    interface ContactRepo <<Interface>>
    interface UserRepo <<Interface>>
    interface FolderRepo <<Interface>>
    interface AttachmentRepo <<Interface>>
    interface FilterRuleRepo <<Interface>>
}

package "Models (Builder & Prototype Pattern)" {
    class Mail {
        - Long id
        - String subject
        - String body
        - LocalDateTime sentAt
        - boolean read
        - boolean active
        - boolean starred
        - boolean hasAttachment
        - int priority
        + static MailBuilder builder()
        + Mail(Mail source)
        + update(Mail source)
    }
    class Attachment {
        - Long id
        - String name
        - String type
        - long size
    }
    class Contact {
        - Long id
        - String name
    }
    class ClientUser {
        - Long id
        - String name
        - String email
    }
    class Folder {
        - Long id
        - String name
    }
    class FilterRule {
        - Long id
        - Map<String, String> criteriaTypesValues
        - String actionType
        - String actionTarget
        + check(Mail): boolean
        + apply(Mail, ActionFactory)
    }

    Mail "1" *-- "*" Attachment : contains
    Mail "*" -- "1" ClientUser : sender
    Mail "*" -- "1" Folder : belongs to
    ClientUser "1" *-- "*" Contact : has
    ClientUser "1" *-- "*" FilterRule : owns
}

package "Commands (Command Pattern)" {
    interface FilterRuleAction <<Interface>> {
        + execute(Mail, String)
    }
    class ActionFactory <<Factory>> {
        + getAction(String): FilterRuleAction
    }
    class MoveToAction implements FilterRuleAction
    class StarAction implements FilterRuleAction
    class MarkAsReadAction implements FilterRuleAction
}

package "Strategies (Strategy Pattern)" {
    class SortWorker {
        - MailSortingStrategy strategy
        + setStrategy(MailSortingStrategy)
        + sort(List<Mail>) : List<Mail>
    }
    interface MailSortingStrategy {
        + SortingMails(List<Mail>) : List<Mail>
    }
    class SortByDate implements MailSortingStrategy
    class SortBySubject implements MailSortingStrategy
    class SortByPriority implements MailSortingStrategy
    class SortBySender implements MailSortingStrategy
    class SortByBody implements MailSortingStrategy
    class SortByReceiver implements MailSortingStrategy
    class SortByAttachment implements MailSortingStrategy

    class ContactSortWorker {
        - ContactSortingStrategy strategy
        + sort(List<Contact>)
    }
    interface ContactSortingStrategy {
        + sort(List<Contact>)
    }
    class ContactSortByName implements ContactSortingStrategy
    class ContactSortByEmails implements ContactSortingStrategy
}

package "Filters (Criteria Pattern)" {
    interface Criteria {
        + meetCriteria(List<Mail>) : List<Mail>
    }
    class CriteriaFactory <<Factory>> {
        + getCriteria(String criteriaName, Object value) : Criteria
    }
    class CriteriaSubject implements Criteria
    class CriteriaSender implements Criteria
    class CriteriaPriority implements Criteria
    class CriteriaBody implements Criteria
    class CriteriaReceiver implements Criteria
    class CriteriaDay implements Criteria
    class CriteriaMonth implements Criteria
    class CriteriaYear implements Criteria
    class CriteriaHasAttachment implements Criteria
}

' Relationships
MailController --> MailService : Delegates
ContactController --> ContactService : Delegates
AuthController --> AuthService : Delegates
FolderController --> FolderService : Delegates
AttachmentController --> AttachmentService : Delegates
FilterRuleController --> FilterRuleService : Delegates

MailService --> MailRepo : Uses
MailService --> UserRepo : Uses
MailService --> FolderRepo : Uses
MailService --> MailMapperImpl : Uses
MailService ..> SortWorker : Uses
MailService ..> CriteriaFactory : Uses
MailService ..> ActionFactory : Uses

ContactService --> ContactRepo : Uses
ContactService ..> ContactSortWorker : Uses

AuthService --> UserRepo : Uses
AuthService --> JWTService : Uses
AuthService --> FolderService : Uses

FolderService --> FolderRepo : Uses
AttachmentService --> AttachmentRepo : Uses
FilterRuleService --> FilterRuleRepo : Uses

MailMapperImpl ..> MailDTO : Creates
MailMapperImpl ..> Mail : Maps to

CriteriaFactory ..> Criteria : Creates
ActionFactory ..> FilterRuleAction : Creates
SortWorker o-- MailSortingStrategy : Has
ContactSortWorker o-- ContactSortingStrategy : Has

FilterRule --> ActionFactory : Uses

@enduml

