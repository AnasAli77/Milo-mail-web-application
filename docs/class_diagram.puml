@startuml
' A4 Portrait - Clean Beautiful Theme with Full Details
!theme plain
skinparam backgroundColor #FEFEFE
skinparam classFontSize 10
skinparam classAttributeFontSize 9
skinparam packageFontSize 11
skinparam packageFontStyle bold
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 20
skinparam ranksep 25
skinparam roundCorner 8
skinparam shadowing false
skinparam defaultFontName Arial
skinparam wrapWidth 150
scale max 750 width

skinparam class {
    BackgroundColor #F8F9FA
    BorderColor #6C757D
    ArrowColor #495057
}

skinparam package {
    BackgroundColor #E9ECEF
    BorderColor #ADB5BD
}

title <size:14><b>Milo Mail System - Design Patterns Architecture</b></size>

' ========== CONTROLLERS ==========
package "Controllers" #E3F2FD {
    class MailController <<Facade>> {
        + getMails(filter, val): Page<MailDTO>
        + sendMail(files[], mailDTO): ResponseEntity
        + getSortedMails(sortBy, folder): Page<MailDTO>
        + moveMails(ids, folder): void
        + deleteMail(id): void
    }
    class ContactController {
        + getContacts(sort): List<Contact>
        + addContact(contact): Contact
        + deleteContact(id): void
    }
    class AuthController {
        + register(userDTO): ResponseEntity
        + login(userDTO): ResponseEntity
    }
    class FolderController {
        + getAllFolders(): List<String>
        + createFolder(name): Folder
        + deleteFolder(name): void
        + renameFolder(old, new): void
    }
    class AttachmentController {
        + downloadAttachment(id): byte[]
    }
    class FilterRuleController {
        + getFilterRules(): List<FilterRule>
        + addFilterRule(dto): FilterRule
        + deleteFilterRule(id): void
    }
}

' ========== SERVICES ==========
package "Services (Singleton)" #E8F5E9 {
    class MailService <<Facade>> {
        + GetAllMails(): void
        + saveMail(dto, files): void
        + updateMail(dto, files): void
        + deleteMail(id): void
        + getMailsByFolder(folder, page, size): Page
        + getSortedMails(sortBy, folder, page, size): Page
        + Search(dto, page, size): Page
        + Filter(dto, page, size): Page
    }
    class ContactService {
        + getContacts(): List<Contact>
        + addContact(contact): Contact
        + getSortedContacts(sortBy): List
    }
    class AuthService {
        + register(user): void
        + verify(user): UserDTO
        + exists(email): boolean
    }
    class FolderService {
        + getFolderNames(): String[]
        + createFolder(name): Folder
        + removeFolder(name): void
        + renameFolder(old, new): void
    }
    class JWTService {
        + generateToken(email): String
        + validateToken(token, user): boolean
        + extractEmail(token): String
    }
    class FilterRuleService {
        + getFilters(): List<FilterRule>
        + addFilter(dto): FilterRule
        + deleteFilter(id): void
    }
    class TrashCleanupService {
        + cleanOldMails(): void
    }
}

' ========== SECURITY ==========
package "Security (Chain of Responsibility)" #FFF3E0 {
    abstract class OncePerRequestFilter {
        + doFilterInternal(req, res, chain)
    }
    class JWTFilter extends OncePerRequestFilter {
        + doFilterInternal(req, res, chain)
    }
    class SecurityConfig {
        + filterChain(http): SecurityFilterChain
    }
}

' ========== CACHE ==========
package "Cache (Caffeine)" #FFFDE7 {
    class CacheConfig <<Configuration>> {
        + cacheManager(): CacheManager
    }
}

' ========== MAPPERS ==========
package "Mappers" #F5F5F5 {
    interface MailMapper {
        + toDto(Mail): MailDTO
        + toEntity(MailDTO, files): Mail
    }
    class MailMapperImpl implements MailMapper
    
    interface AttachmentMapper {
        + toDto(Attachment): AttachmentDTO
        + toEntity(AttachmentDTO): Attachment
    }
    class AttachmentMapperImpl implements AttachmentMapper
}

' ========== DTOs ==========
package "Data Transfer Objects" #ECEFF1 {
    class MailDTO {
        + subject: String
        + body: String
        + priority: int
        + senderEmail: String
        + receiverEmails: Queue<String>
        + attachments: List<AttachmentDTO>
    }
    class UserDTO {
        + name: String
        + email: String
        + token: String
    }
    class FilterRuleDTO {
        + criteriaTypesValues: Map
        + actionType: String
        + actionTarget: String
    }
}

' ========== REPOSITORIES ==========
package "Repositories" #F5F5F5 {
    interface MailRepo
    interface UserRepo
    interface FolderRepo
    interface ContactRepo
    interface FilterRuleRepo
    interface AttachmentRepo
}

' ========== MODELS ==========
package "Models (Builder & Prototype)" #FCE4EC {
    interface "Prototype<T>" as Prototype {
        + clone(): T
    }
    
    class Mail <<Builder>> implements Prototype {
        - id: Long
        - subject: String
        - body: String
        - sentAt: LocalDateTime
        - read: boolean
        - starred: boolean
        - hasAttachment: boolean
        - priority: int
        --
        + builder(): MailBuilder
        + clone(): Mail
        + cloneWithReceiver(user): Mail
        + update(source): void
    }
    class Attachment {
        - id: Long
        - name: String
        - type: String
        - size: long
    }
    class AttachmentContent {
        - data: byte[]
    }
    class Contact {
        - id: Long
        - name: String
        - emails: List<String>
    }
    class ClientUser {
        - id: Long
        - name: String
        - email: String
        - password: String
    }
    class Folder {
        - id: Long
        - name: String
    }
    class FilterRule {
        - id: Long
        - criteriaTypesValues: Map
        - actionType: String
        - actionTarget: String
        --
        + check(mail): boolean
        + apply(mail, factory): void
    }

    Mail "1" *-- "*" Attachment
    Attachment "1" -- "1" AttachmentContent
    Mail "*" -- "1" ClientUser : sender
    Mail "*" -- "1" Folder
    ClientUser "1" *-- "*" Contact
    ClientUser "1" *-- "*" FilterRule
    ClientUser "1" *-- "*" Folder
}

' ========== COMMAND PATTERN ==========
package "Commands (Command Pattern)" #FFFDE7 {
    interface FilterRuleAction {
        + execute(mail, target): void
    }
    class ActionFactory <<Factory>> {
        - actionMap: Map
        + getAction(type): FilterRuleAction
    }
    class MoveToAction implements FilterRuleAction {
        + execute(mail, folder): void
    }
    class StarAction implements FilterRuleAction {
        + execute(mail, target): void
    }
    class MarkAsReadAction implements FilterRuleAction {
        + execute(mail, target): void
    }
}

' ========== STRATEGY PATTERN ==========
package "Strategies (Strategy Pattern)" #E1F5FE {
    class SortWorker {
        - strategy: MailSortingStrategy
        + setStrategy(strategy): void
        + sort(mails): List<Mail>
    }
    interface MailSortingStrategy {
        + SortingMails(mails): List<Mail>
    }
    class SortByDate implements MailSortingStrategy
    class SortBySubject implements MailSortingStrategy
    class SortByPriority implements MailSortingStrategy
    class SortBySender implements MailSortingStrategy
    class SortByReceiver implements MailSortingStrategy
    class SortByAttachment implements MailSortingStrategy

    SortWorker o-- MailSortingStrategy
}

' ========== CRITERIA PATTERN ==========
package "Filters (Criteria Pattern)" #F3E5F5 {
    interface Criteria {
        + filter(mails): List<Mail>
    }
    class CriteriaFactory <<Factory>> {
        + create(name, value): Criteria
    }
    class CriteriaSubject implements Criteria
    class CriteriaSender implements Criteria
    class CriteriaPriority implements Criteria
    class CriteriaBody implements Criteria
    class CriteriaReceiver implements Criteria
    class CriteriaDay implements Criteria
    class CriteriaMonth implements Criteria
    class CriteriaYear implements Criteria
    class CriteriaHasAttachment implements Criteria
}

' ========== KEY RELATIONSHIPS ==========
MailController --> MailService
ContactController --> ContactService
AuthController --> AuthService
FolderController --> FolderService
FilterRuleController --> FilterRuleService

MailService --> MailRepo
MailService --> MailMapperImpl
MailService ..> SortWorker
MailService ..> CriteriaFactory
MailService --> ActionFactory

AuthService --> JWTService
AuthService --> UserRepo

FilterRule --> ActionFactory
SecurityConfig --> JWTFilter
CriteriaFactory ..> Criteria : creates
ActionFactory ..> FilterRuleAction : creates

@enduml
