@startuml
' A4 Portrait - Clean Beautiful Theme
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam defaultFontSize 10
skinparam roundCorner 8
skinparam shadowing false
skinparam sequenceMessageAlign center
scale max 750 width

skinparam participant {
    BackgroundColor #F8F9FA
    BorderColor #6C757D
}

skinparam note {
    BackgroundColor #FFF9C4
    BorderColor #FBC02D
    FontSize 9
}

title <size:14><b>Send Mail Workflow with Filter Rules</b></size>

actor Sender #E3F2FD
participant "Angular Frontend" as Frontend #E8F5E9
participant "MailController" as Controller #E3F2FD
participant "MailService" as Service #E3F2FD
participant "Mail" as MailEntity #FCE4EC
participant "FilterRuleRepo" as RuleRepo #F5F5F5
participant "FilterRule" as Rule #F3E5F5
participant "ActionFactory" as AFactory #FFFDE7
participant "FilterRuleAction" as Action #FFFDE7
participant "FolderRepo" as FolderRepo #F5F5F5
database "PostgreSQL" as DB #FCE4EC

Sender -> Frontend : Click "Send"
activate Frontend #E8F5E9

note over Frontend #E8F5E9
**Frontend Validation**
- Subject not empty
- Body not empty
- At least one valid receiver
end note

Frontend -> Controller : POST /mail/add
activate Controller #E3F2FD

Controller -> Service : saveMail(mailDTO, files)
activate Service #E3F2FD

note over Service #E3F2FD
**Step 1: Create sender's copy**
end note

Service -> MailEntity : clone()
activate MailEntity #FCE4EC
note right of MailEntity #FCE4EC
**Prototype Pattern**
Deep copy mail with
all attachments
end note
MailEntity --> Service : senderMail (clone)
deactivate MailEntity

Service -> DB : save(senderMail)
activate DB #FCE4EC
DB --> Service : savedMail
deactivate DB

note over Service #E3F2FD
**Step 2: Process each receiver**
end note

loop For each receiver email
    Service -> MailEntity : cloneWithReceiver(receiver)
    activate MailEntity #FCE4EC
    note right of MailEntity #FCE4EC
    **Prototype Pattern**
    Clone + set receiver
    end note
    MailEntity --> Service : receiverMail
    deactivate MailEntity
    
    Service -> RuleRepo : findByUserEmail(receiverEmail)
    activate RuleRepo #F5F5F5
    RuleRepo --> Service : List<FilterRule>
    deactivate RuleRepo

    loop For each FilterRule
        Service -> Rule : check(mail)
        activate Rule #F3E5F5
        note right of Rule #F3E5F5
        Iterates criteriaTypesValues
        using **Criteria Pattern**
        end note
        Rule --> Service : boolean matches
        deactivate Rule
        
        alt If rule matches
            Service -> Rule : apply(mail, actionFactory)
            activate Rule #F3E5F5
            
            Rule -> AFactory : getAction(actionType)
            activate AFactory #FFFDE7
            note right of AFactory #FFFDE7
            **Factory Pattern**
            end note
            AFactory --> Rule : FilterRuleAction
            deactivate AFactory
            
            Rule -> Action : execute(mail, targetValue)
            activate Action #FFFDE7
            note right of Action #FFFDE7
            **Command Pattern**
            - MoveToAction
            - StarAction
            - MarkAsReadAction
            end note
            Action -> FolderRepo : findByNameAndUserEmail()
            Action --> Rule
            deactivate Action
            
            Rule --> Service
            deactivate Rule
        end
    end
    
    alt If no folder set
        Service -> FolderRepo : findByNameAndUserEmail("inbox", email)
        Service -> Service : mail.setFolder(inbox)
    end
    
    Service -> DB : save(receiverMail)
end

Service --> Controller : success
deactivate Service

Controller --> Frontend : 200 OK
deactivate Controller

Frontend --> Sender : "Email Sent Successfully"
deactivate Frontend

@enduml
