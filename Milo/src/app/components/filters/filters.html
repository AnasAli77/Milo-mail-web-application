<div class="filters-wrapper">

  <!-- LEFT SIDEBAR: List of Filters -->
  <div class="filters-sidebar custom-scrollbar">
    <div class="sidebar-header">
      <h2>Filters</h2>
      <button class="add-btn" (click)="toggleCreateForm()" title="Create new filter">
        +
      </button>
    </div>

    <div class="sidebar-list custom-scrollbar">
      @if (filters().length === 0) {
      <div class="empty-list-msg">
        <p>No filters created yet</p>
      </div>
      }

      @for (filter of filters(); track filter.id) {
      <div class="list-item" [class.active]="selectedFilter()?.id === filter.id" (click)="selectFilter(filter)">

        <div class="item-content">
          <div class="item-title">
            {{ filter.subject || filter.sender || 'Custom Rule' }}
          </div>
          <div class="item-details">
            @if (filter.moveToFolderId) { <span class="badge move">→ {{ filter.moveToFolderId }}</span> }
            @if (filter.star) { <span class="badge star">★ Star</span> }
            @if (filter.markAsRead) { <span class="badge read">✓ Read</span> }
          </div>
        </div>

        <button class="delete-icon" (click)="deleteFilter(filter.id!); $event.stopPropagation()">
          ✕
        </button>
      </div>
      }
    </div>
  </div>

  <!-- RIGHT CONTENT: Create/Edit Form -->
  <div class="filters-content">

    @if (!isSearchFilterOpen() && !selectedFilter()) {
    <div class="content-empty-state">
      <h3>Select a filter or create a new one</h3>
      <p class="hint-text">Click the + button to get started</p>
    </div>
    } @else {
    <div class="form-scroll-wrapper custom-scrollbar">

      <form [formGroup]="filterForm" (ngSubmit)="onAdvancedSearch()" class="clean-form">

        <div class="form-header-row">
          <h2>{{ isSearchFilterOpen() ? 'Create Filter' : 'Filter Details' }}</h2>
          @if (isSearchFilterOpen()) {
          <button type="button" class="close-text-btn" (click)="toggleCreateForm()">✕</button>
          }
        </div>

        <div class="section-label">Match Criteria</div>

        <!-- FROM -->
        <div class="form-group">
          <label>From</label>
          <input type="text" formControlName="searchFrom" placeholder="sender@example.com">
        </div>

        <!-- TO -->
        <div class="form-group">
          <label>To</label>
          <input type="text" formControlName="searchTo" placeholder="recipient@example.com">
        </div>

        <!-- SUBJECT -->
        <div class="form-group">
          <label>Subject</label>
          <input type="text" formControlName="searchSubject" placeholder="Contains text...">
        </div>

        <!-- BODY -->
        <div class="form-group">
          <label>Body</label>
          <input type="text" formControlName="searchQuery" placeholder="Message contains...">
        </div>

        <!-- PRIORITY -->
        <div class="form-group">
          <label>Priority</label>
          <select formControlName="searchPriority">
            <option value="">Any Priority</option>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Normal</option>
            <option value="4">High</option>
            <option value="5">Extreme</option>
          </select>
        </div>

        <!-- DATE -->
        <div class="form-group">
          <label>Date</label>
          <div class="date-row-inputs">
            <input type="text" class="year" formControlName="searchYear" placeholder="YYYY" maxlength="4">
            <span class="date-sep">-</span>
            <input type="text" formControlName="searchMonth" placeholder="MM" maxlength="2">
            <span class="date-sep">-</span>
            <input type="text" formControlName="searchDay" placeholder="DD" maxlength="2">
          </div>
        </div>

        <!-- ATTACHMENT -->
        <div class="form-group checkbox-group">
          <label></label>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="chkAtt" formControlName="searchHasAttachment">
            <label class="check-label" for="chkAtt">Has attachment</label>
          </div>
        </div>

        <div class="section-label">Action to Perform</div>

        <!-- ACTION TYPE DROPDOWN -->
        <div class="form-group">
          <label>Action</label>
          <select formControlName="actionType">
            <option value="markasread">Mark as read</option>
            <option value="star">Star it</option>
            <option value="move">Move to folder</option>
          </select>
        </div>

        <!-- CONDITIONAL FOLDER DROPDOWN -->
        @if (filterForm.get('actionType')?.value === 'move') {
        <div class="form-group">
          <label>Folder</label>
          <select formControlName="actionTarget">
            <option value="">Select destination...</option>
            @for (f of filteredFolders(); track $index) {
            <option [value]="f">{{ f | titlecase }}</option>
            }
          </select>
        </div>
        }

        <!-- FOOTER ACTIONS - Fixed at bottom -->
        <div class="form-actions-row">
          @if (selectedFilter()) {
          <button type="button" class="btn-delete" (click)="deleteFilter(selectedFilter()?.id!)">
            Delete
          </button>
          }

          @if (isSearchFilterOpen()) {
          <button type="submit" class="btn-save">Create Filter</button>
          }
        </div>

      </form>
    </div>
    }
  </div>
</div>